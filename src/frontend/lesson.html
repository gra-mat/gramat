<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="lib/pure.min.css" />
    <title>Document</title>

    <script type="module" src="components/exercise-viewer.js"></script>
    <script type="module" src="components/exercises/addsub-exercise.js"></script>
    <script type="module" src="components/partial/success-mark.js"></script>
    <script type="module" src="components/summary-viewer.js"></script>

    <style>
      html, body {
        height: 100%; width: 100%; background-color: #2c2c54; color: white;
      }
    </style>
  </head>

  <body>
    <x-exercise-view>
      <x-addsub-exercise></x-addsub-exercise>
    </x-exercise-view>

    <summary-viewer
      id="summary"
      class="hidden"
      time="0m 37s"
      accuracy="100%"
      xp="+70 XP">
    </summary-viewer>

    <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const params = new URLSearchParams(location.search);
    const lessonId = params.get('lessonId');
    if (!lessonId) return;

    const r = await fetch(`/api/lesson/${lessonId}`);
    if (!r.ok) { console.error('Nie można pobrać lekcji', r.status); return; }
    const data = await r.json();
    const exercises = data.exercises || [];
    if (!exercises.length) return;

    const view = document.querySelector('x-exercise-view');
    const addSub = document.querySelector('x-addsub-exercise');

    let startTime = Date.now();
    let correctAnswers = 0;
    let wrongAnswers = 0;

    view && view.setAttribute('progress-step', String(100 / exercises.length));

    let idx = 0;
    addSub.setAttribute('exercise-id', String(exercises[idx].id));

    const updateTimer = () => {
      const elapsedTime = Date.now() - startTime;
      const minutes = Math.floor(elapsedTime / 1000 / 60);
      const seconds = Math.floor((elapsedTime / 1000) % 60);

      const timerElement = document.getElementById("timer");
      if (timerElement) {
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;
      }
    };

    const timerInterval = setInterval(updateTimer, 1000);

    view.addEventListener("next-exercise", () => {

      const wasCorrect = !!addSub.isCorrect;
      if (wasCorrect) correctAnswers++;
      else wrongAnswers++;

      idx++; 

      if (idx >= exercises.length) {
        const summary = document.querySelector("#summary");
        if (!summary) {
          console.error("Nie znaleziono elementu summary!");
          return;
        }

        document.querySelector("x-exercise-view").classList.add("hidden");

        const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsedTime / 60);
        const seconds = elapsedTime % 60;

        const total = exercises.length;
        const accuracy = Math.round((correctAnswers / total) * 100);
        const xp = (correctAnswers * 10).toFixed(0);

        
        summary.setAttribute("time", `${minutes}m ${seconds}s`);
        summary.setAttribute("accuracy", `${accuracy}%`);
        summary.setAttribute("xp", `+${xp} XP`);
        console.log(correctAnswers);
        console.log(total);
        summary.classList.remove("hidden");

        clearInterval(timerInterval);

        fetch("/api/me/lessonCompleted", {
          method: "POST",
          credentials: "include",
          body: JSON.stringify({
            "lessonId": lessonId,
            "time": elapsedTime,
            "accuracy": accuracy,
            "xp": Number(xp)
          }),
          headers: {
            "Content-type": "application/json; charset=UTF-8"
          }
        });
        console.log("Lekcja zakończona");

        return;
      }

      addSub.setAttribute("exercise-id", String(exercises[idx].id));
    });
  });
</script>

  </body>
</html>